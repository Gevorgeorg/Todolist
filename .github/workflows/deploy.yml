name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/todo-api:latest
            ${{ secrets.DOCKER_USERNAME }}/todo-api:${{ github.sha }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./todolist-frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/todo-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/todo-frontend:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Yandex Cloud VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Останавливаем текущие контейнеры
            cd /home/${{ secrets.SERVER_USER }}/todo-app || mkdir -p /home/${{ secrets.SERVER_USER }}/todo-app && cd $_
            
            # Создаем необходимые файлы
            cat > docker-compose.prod.yml << 'EOF'
            version: '3.8'
            
            services:
              postgres:
                image: postgres:15-alpine
                container_name: todo-postgres
                environment:
                  POSTGRES_USER: myuser
                  POSTGRES_PASSWORD: mypassword
                  POSTGRES_DB: mydb
                ports:
                  - "5432:5432"
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                restart: unless-stopped
                networks:
                  - todo-network
            
              api:
                image: ${{ secrets.DOCKER_USERNAME }}/todo-api:latest
                container_name: todo-api
                command: >
                  sh -c "python manage.py migrate --noinput &&
                         python manage.py collectstatic --noinput &&
                         python manage.py runserver 0.0.0.0:8000"
                environment:
                  DATABASE_URL: postgresql://myuser:mypassword@postgres:5432/mydb
                  DEBUG: "False"
                  SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
                  ALLOWED_HOSTS: "localhost,127.0.0.1,api,front,${{ secrets.SERVER_HOST }},89.169.156.104"
                ports:
                  - "8000:8000"
                volumes:
                  - static_volume:/app/staticfiles
                depends_on:
                  - postgres
                restart: unless-stopped
                networks:
                  - todo-network
            
              front:
                image: ${{ secrets.DOCKER_USERNAME }}/todo-frontend:latest
                container_name: todo-front
                ports:
                  - "80:80"
                depends_on:
                  - api
                restart: unless-stopped
                networks:
                  - todo-network
            
            volumes:
              postgres_data:
              static_volume:
            
            networks:
              todo-network:
                driver: bridge
            EOF
            
            # Создаем .env файл для секретов
            cat > .env << EOF
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            EOF
            
            # Создаем скрипт деплоя
            cat > deploy.sh << 'EOF'
            #!/bin/bash
            echo "=== Останавливаем старые контейнеры ==="
            docker compose -f docker-compose.prod.yml down || true
            
            echo "=== Удаляем старые образы ==="
            docker rmi ${{ secrets.DOCKER_USERNAME }}/todo-api:latest || true
            docker rmi ${{ secrets.DOCKER_USERNAME }}/todo-frontend:latest || true
            
            echo "=== Логинимся в Docker Hub ==="
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            echo "=== Запускаем новые контейнеры ==="
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            
            echo "=== Очищаем неиспользуемые образы ==="
            docker image prune -f
            
            echo "=== Проверяем статус ==="
            docker ps
            EOF
            
            # Делаем скрипт исполняемым и запускаем
            chmod +x deploy.sh
            ./deploy.sh