name: Deploy TodoList

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ðŸš€ Starting deploy..."
          cd /home/ubuntu/todo-app
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          cp -f ${{ github.workspace }}/docker-compose.yml .
          cp -f ${{ github.workspace }}/Dockerfile .
          cp -f ${{ github.workspace }}/requirements.txt .
          cp -f ${{ github.workspace }}/manage.py .
          cp -rf ${{ github.workspace }}/core .
          cp -rf ${{ github.workspace }}/goals .
          cp -rf ${{ github.workspace }}/bot .
          cp -rf ${{ github.workspace }}/Todolist .
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
          if [ ! -f .env ]; then
            cat > .env << 'EOF'
          DEBUG=True
          SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
          ALLOWED_HOSTS=localhost,127.0.0.1,api,frontend,${{ secrets.SERVER_HOST }}
          POSTGRES_USER=myuser
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=todolist_db
          SOCIAL_AUTH_VK_OAUTH2_KEY=54378867
          SOCIAL_AUTH_VK_OAUTH2_SECRET=${{ secrets.VK_SECRET }}
          BASE_URL=http://${{ secrets.SERVER_HOST }}
          SOCIAL_AUTH_VK_OAUTH2_REDIRECT_URI=http://${{ secrets.SERVER_HOST }}/oauth/complete/vk-oauth2/
          STATIC_ROOT=/app/staticfiles
          EOF
          fi
          
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð·Ð°Ð½Ð¾Ð²Ð¾
          docker-compose down
          docker-compose build
          docker-compose up -d
          
          echo "âœ… Deploy completed!"
          echo "ðŸŒ App available at: http://${{ secrets.SERVER_HOST }}"