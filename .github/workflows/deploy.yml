name: Build and Deploy TodoList

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 1. –°–æ–±–∏—Ä–∞–µ–º API
      - name: Build and push Django API image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/todo-api:latest
            ${{ secrets.DOCKER_USERNAME }}/todo-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 2. –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (–î–û–ë–ê–í–¨ –≠–¢–û!)
      - name: Build and push Angular Frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./todolist-frontend
          file: ./todolist-frontend/docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/todo-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/todo-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 3. –î–û–ë–ê–í–¨ –≠–¢–û–¢ –ù–û–í–´–ô JOB –î–õ–Ø –î–ï–ü–õ–û–Ø
  deploy:
    needs: build-and-push  # –ñ–¥–µ–º –ø–æ–∫–∞ —Å–æ–±–µ—Ä—É—Ç—Å—è –æ–±—Ä–∞–∑—ã
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Yandex Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π..."
            cd /home/ubuntu/todo-app
            
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ
            docker-compose -f docker-compose.prod.yml down
            
            # –¢—è–Ω–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
            docker-compose -f docker-compose.prod.yml pull
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º
            docker-compose -f docker-compose.prod.yml up -d
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 10
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
            echo "   –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://${{ secrets.SERVER_HOST }}"
            echo "   API: http://${{ secrets.SERVER_HOST }}:8000"