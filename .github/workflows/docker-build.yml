name: Build and Push TodoList Images

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 1. –°–±–æ—Ä–∫–∞ Django API –æ–±—Ä–∞–∑–∞
      - name: Build and push Django API image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/todo-api:latest
            ${{ secrets.DOCKER_USERNAME }}/todo-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 2. –°–±–æ—Ä–∫–∞ Angular Frontend –æ–±—Ä–∞–∑–∞ (–î–û–ë–ê–í–¨ –≠–¢–û–¢ –®–ê–ì!)
      - name: Build and push Angular Frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./todolist-frontend
          file: ./todolist-frontend/docker/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/todo-frontend:latest
            ${{ secrets.DOCKER_USERNAME }}/todo-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push  # –ñ–¥–µ–º —Å–±–æ—Ä–∫—É
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            cd /home/ubuntu/todo-app
            
            # –õ–æ–≥–∏–Ω–∏–º—Å—è
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ
            docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
            
            # –¢—è–Ω–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã
            echo "–ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/todo-api:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/todo-frontend:latest
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º
            echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            sleep 10
            echo "=== –°—Ç–∞—Ç—É—Å ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ ==="
            if curl -s -f http://localhost:80 > /dev/null; then
              echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç: http://${{ secrets.SERVER_HOST }}"
            else
              echo "‚ùå –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            fi
            
            if curl -s -f http://localhost:8000 > /dev/null; then
              echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç: http://${{ secrets.SERVER_HOST }}:8000"
            else
              echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            fi